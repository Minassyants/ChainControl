version: '3.7'

services:
  web:
    image: killka1997/autodom-img
   

    expose:
    - 8000
    volumes:
      - static_volume:/Autodom-app/Autodom/static/:rw
      - media_volume:/Autodom-app/Autodom/media/:rw
    environment:
      - DJANGO_SETTINGS_MODULE=Autodom.settings
      - BROKER_URL=redis://redis:6379
      - RESULT_BACKEND=redis://redis:6379
      - POSTGRES_PASSWORD=qwerty1234
      - POSTGRES_USER=admin123
      - POSTGRES_HOST=db
      - LETSENCRYPT_HOST=localhost
      - VIRTUAL_HOST=localhost
      - VIRTUAL_PORT=8000
    depends_on:
      - redis
      - db

  celery:
    image: killka1997/autodom-img
   
    command: celery -A Autodom worker --autoscale=5,1 --loglevel=info
    volumes:
      - static_volume:/Autodom-app/Autodom/static/:rw
    environment:
      - DJANGO_SETTINGS_MODULE=Autodom.settings
      - BROKER_URL=redis://redis:6379
      - RESULT_BACKEND=redis://redis:6379
      - POSTGRES_PASSWORD=qwerty1234
      - POSTGRES_USER=admin123
      - POSTGRES_HOST=db
    depends_on:
      - web
      - redis
  
  beat:
    image: killka1997/autodom-img
   
    command: celery -A Autodom beat -l DEBUG
    volumes:
      - static_volume:/Autodom-app/Autodom/static/:rw
    environment:
      - DJANGO_SETTINGS_MODULE=Autodom.settings
      - BROKER_URL=redis://redis:6379
      - RESULT_BACKEND=redis://redis:6379
      - POSTGRES_PASSWORD=qwerty1234
      - POSTGRES_USER=admin123
      - POSTGRES_HOST=db
    depends_on:
      - web
      - redis
      - celery
      - db


  redis:
    image: redis


  flower:
    image: killka1997/autodom-img
   
    command: celery -A Autodom flower --address=0.0.0.0 --port=5566
    expose:
     - 5566
    environment:
      - DJANGO_SETTINGS_MODULE=Autodom.settings
      - BROKER_URL=redis://redis:6379
      - RESULT_BACKEND=redis://redis:6379
      - POSTGRES_PASSWORD=qwerty1234
      - POSTGRES_USER=admin123
      - POSTGRES_HOST=db
    depends_on:
      - celery
      - redis

  db:
      image: postgres
    
      expose:
        - 5432
      volumes:
      - postgres_data:/var/lib/postgresql/data/
      environment:
      - POSTGRES_PASSWORD=qwerty1234
      - POSTGRES_USER=admin123
      - POSTGRES_HOST=db

  nginx-proxy:
    image: jwilder/nginx-proxy
    container_name: nginx-proxy
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /etc/nginx/vhost.d
      - /etc/nginx/certs
      - /usr/share/nginx/html
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - ./nginx/default_location:/etc/nginx/vhost.d/default_location
      - static_volume:/home/app/web/staticfiles/:rw
      - media_volume:/home/app/web/media/:rw
 
  ssl-generator:
    image: jrcs/letsencrypt-nginx-proxy-companion
    volumes_from:
      - nginx-proxy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    
        


volumes:
  static_volume:
    driver: local
  media_volume:
    driver: local
  postgres_data:
    driver: local